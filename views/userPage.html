<!DOCTYPE html>
<html>
  <head>
    <title>SXDiscover</title>
    <link rel="stylesheet" type="text/css" href="/stylesheets/reset.css">
    <link rel="stylesheet" type="text/css" href="/stylesheets/userpage-style.css">
    <link rel="stylesheet" type="text/css" href="/stylesheets/userPage-grid.css">

<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- <meta name="viewport" content="width=device-width initial-scale = 1.0 maximum-scale=1.0 user-scalable=no" /> -->
    <link rel="shortcut icon" href="http://sxdiscover.co/favicon.ico?v=2">

    <!-- Facebook link previews -->
    <!-- You can use Open Graph tags to customize link previews.
      Learn more: https://developers.facebook.com/docs/sharing/webmasters -->
    <meta property="fb:app_id"        content="618293678380263" />
    <meta property="og:url"           content="{{link}}" />
    <meta property="og:type"          content="website" />
    <meta property="og:title"         content="{{fbShareMessage}}" />
    <meta property="og:description"   content="Log in with Spotify to find out if your favorite bands are playing SXSW." />
    <meta property="og:image"         content="http://sxdiscover.co/images/sxd.png" />
    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
      ga('create', 'UA-75031530-1', 'auto');
      ga('send', 'pageview');
    </script>
  </head>
  <body class="site">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>
    <script src="/javascripts/global.js"></script>
    <script src="/javascripts/date.js"></script>
    <script src="/javascripts/moment.js"></script>

    <!-- UPDATE: 2017 Facebook SDK code for share button -->
    <div id="fb-root"></div>
    <script>(function(d, s, id) {
      var js, fjs = d.getElementsByTagName(s)[0];
      if (d.getElementById(id)) return;
      js = d.createElement(s); js.id = id;
      js.src = "//connect.facebook.net/en_US/sdk.js#xfbml=1&version=v2.8&appId=618293678380263";
      fjs.parentNode.insertBefore(js, fjs);
      }(document, 'script', 'facebook-jssdk'));
    </script>
    <script>

      var results = ['SX'];
      var bands = "{{bands}}";
      var days = [];
      var currentDay = 0;

      // Remove &quot; and replace with actual quotes
      bands = JSON.parse(bands.replace(/&quot;/g,'"'));

      // Convert date and time into milliseconds to sort by date
      bands.sort(function(a,b){
        if(a["time"]=='TBD'){
          a["time"] = '00:00'
        }
        if(b["time"]=='TBD'){
          b["time"] = '00:00'
        }

        return Date.parse(a["date"]+" 2018 "+a["time"])-Date.parse(b["date"]+" 2018 "+b["time"]);
      });

      $(document).ready(function() {
          populateTable(function(){

            var today = new Date().getDate();
            var currentDayIndex = 0

            // If date is less than today, hide and show next one
            for(var i=0;i<results.length;i++){
              var dayNum = Date.parse(results[i][0].date).getDate();

              // If the current day is earlier than today, then move to the next day
              if(today-dayNum>0){
                currentDayIndex += 1
              }
            }

            // Hide all days
            for(var i=0;i<days.length;i++){
              $('#'+days[i]).hide();
            }

            // Only show current day that was calculated earlier
            // Set currentDay to the index value (the day button functions use this value)
            currentDay = currentDayIndex
            $('#current-day').html(results[currentDayIndex][0].dayString);
            $('#'+days[currentDayIndex]).show();
        });
      });

      function convertBandInfoToDiv(bandData){

        var html = '';
        for(var i=0;i<bandData.length;i++){

          var isPlaylist = false
          var hasSource = false

          if(bandData[i][5]!="none"){
            hasSource=true
            if(bandData[i][6]!=""){
            isPlaylist = true
            }
          }

          // Adding link and band name
          html += '<a class="card" href=\''+bandData[i][3]+'\' target="_blank">';
          html += '<h2 class="artist">'+bandData[i][0]+'</h2>'

          // Checking if there's a source and adding it
          if(hasSource){
            var source = bandData[i][5]
            var sourceText = ""
            switch(source){
              case "top":
                sourceText = "Recently played";
                break;
              case "playlist":
                var playlist = bandData[i][6];
                sourceText = "From the playlist "+playlist;
                break;
              case "album":
                sourceText = "From your library"
                break;
              case "related":
                var relatedToBand = bandData[i][6]
                sourceText = "Because you like "+relatedToBand;
                break;
              default:
                break;
            }
            html += '<h3 class="source">'+sourceText+'</h3>'
          } else {
            html += '<h3 class="source">No source</h3>'
          }

          // Adding venue and time
          html += '<h3 class="venue">'+bandData[i][1]+ ' '+bandData[i][2]+'</h3>';

          // Adding price
          html += '<h3 class="price">'+bandData[i][4]+'</h3>'

          html += '</a>';
        }
        return html;
      }

      // Function that returns the correct suffix for a given date, e.g. if you input 22, it will return "nd" to form "22nd". The approach here is to extract the second digit from the date (e.g. if you input 23, it'll just look at 3), and return a string based on the value of the second digit: 1 = "st", 2 = "nd", 3 = "rd", everything else = "th".

      function getDateSuffix(date){
        // Pull the second digit
        var secondDigit = date % 10

        // Special cases: 11, 12 and 13 are treated as "th"
        if(date==11 || date==12 || date==13){
          return "th"
        }
        // 1st, 2nd, 3rd, 4th, 21st, 22nd, 23rd
        switch(secondDigit){
          case 1:
            return "st"
            break;
          case 2:
            return "nd"
            break;
          case 3:
            return "rd"
            break;
          default:
            return "th"
        }
      }

      function dayButtonClicked(type){
        return function(){
          switch(type){
            case "previous":
              if(currentDay==0){
                currentDay = days.length-1
              } else {
                currentDay-=1
              }
              break;
            default:
              if(currentDay==days.length-1){
                currentDay=0
              } else {
                currentDay+=1
              }
          }

          $('#'+days[currentDay]).show();
          $('#current-day').html(results[currentDay][0].dayString);
          for(var i=0;i<days.length;i++){
            if(i==currentDay){
              // Do nothing
            } else {
              $('#'+days[i]).hide();
            }
          }
        window.scrollTo(0, 0);
        }
      }
      // Store day names for day divs
      var weekdays = new Array(7);
      weekdays[0] = "Sunday";
      weekdays[1] = "Monday";
      weekdays[2] = "Tuesday";
      weekdays[3] = "Wednesday";
      weekdays[4] = "Thursday";
      weekdays[5] = "Friday";
      weekdays[6] = "Saturday";

      function populateTable(callback) {

              // For each item in our JSON, extract the useful info and add it to the results array
              $.each(bands, function(){

                // "source":[{"source":"top","name":"Max Richter"}]

                  try{
                      var n = this.name;
                      var d = this.date;
                      var t = "tbd.";
                      var v = this.venue + ".";
                      var l = this.link;
                      var p = this.price;
                      var s = this.source;
                      var s_n = "";

                      // If there's no source, do nothing.
                      if(s=="none"){
                      } else {
                        s = this.source[0].source
                        if(s=="playlist"){
                          s_n = this.source[0].playlistName
                        }
                        if(s=="related"){
                          s_n = this.source[0].relatedTo
                        }
                    }

                      if(this.time != "TBD"){
                        t = moment(Date.parse(this.time)).format("h:mm a") + ".";
                      }

                  // Add unique dates as a dictionary to the results array, and each band's info as an array under each date
                  for(var i=0;i<results.length; i++){
                    if (results[i][0].date == d){
                      // If a date already exists in the results array, add a new band's info to that date
                    results[i][0].bands.push([n, v, t, l, p, s, s_n]);
                    break;
                    // If a date doesn't exist, add it to the results array
                  } else if (i==results.length-1) {

                    // Get day name
                    var dayNum = Date.parse(this.date).getDay();
                    var date = Date.parse(this.date).getDate();
                    var dayText = weekdays[dayNum];
                    var dayString = dayText+" the "+date+getDateSuffix(date)
                    results.push([{
                      date:d,
                      bands: [[n, v, t, l, p, s, s_n]],
                      dayText:dayText,
                      dayString:dayString
                      }]);
                    break;
                    }
                  }
                } catch (e){
                  console.log("Error: Couldn't access bands from /bands response");
                  console.log(e.message);
                }
              });
                //Remove first element
                // need: 2018 update: remove first day's results
                results = results.slice(1);
                console.log("Results are:")
                console.log(results);

          // Create div for each day and add bands to each div
          for(var i=0;i<results.length;i++){
                var day;
                var date = Date.parse(results[i][0].date).getDate();
                var dateString = results[i][0].dayText;

                if(dateString=="TBD"){
                  day="TBD"
                } else {
                  day = dateString+date
                }
                $('#bandList').append("<div class='bandcards' id='"+day+"''></div>");
                days.push(day);
                $('#'+day).html(convertBandInfoToDiv(results[i][0].bands));
          }

          var buttonHtml = '<button type="button" name="previous" id="previous-day">Previous Day</button><button type="button" name="next" id="next-day">Next Day</button>'

          // Add buttons to footer
          $('#footer').append(buttonHtml)
          $('#previous-day').on('click', dayButtonClicked("previous"));
          $('#next-day').on('click', dayButtonClicked("next"));
          $('#publicLink').html(document.location.href);
          $('body').addClass('siteloaded');

          callback();
      };
    </script>


<!-- header and article (non-nav content) -->
<div class="viewable">
  <div class="daycard">
    <h3>bands playing on</h3>
    <h2 class="currentday" id="current-day"></h2>
  </div>
  <article id="bandList">
  </article>
</div>
<!-- navigation -->
  <footer id="footer">
  </footer>


<script>
    $('#next-day').click(function(){
      console.log("CLICKED!")
    });

    $('#changeStatus').click(function(){
      $.get("/private", function(data) {
        location.reload();
      }); return false;
    });

    $('#changeStatus1').click(function(){
      $.get("/private", function(data) {
        location.reload();
      }); return false;
    });

    if("{{canDelete}}"=='y'){
      $(".friendPage").hide();
      if("{{public}}"=='y'){
        $(".public").show();
        $(".private").hide();
      } else {
        $(".public").hide();
        $(".private").show();
      }
    } else {
        $(".friendPage").show();
        $(".public").hide();
        $(".private").hide();
      }
</script>
      </div>
</body>
</html>
